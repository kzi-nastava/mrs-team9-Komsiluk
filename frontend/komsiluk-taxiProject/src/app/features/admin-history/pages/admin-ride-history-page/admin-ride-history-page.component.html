<div class="history-page app-bg-textured">
  <h1 class="history-page__title" id="page-title">Ride History</h1>
  
  <div class="toolbar">
    <div class="search-section">
      <input
        type="email"
        class="search-input"
        placeholder="Enter user email..."
        id="search-input"
        [(ngModel)]="searchEmail"
        (keyup.enter)="onSearch()"
      />
      <button class="search-btn" id="search-button" (click)="onSearch()">Search</button>
    </div>
    <div class="filter-button-wrapper">
      <button 
        class="filter-toggle-btn" 
        (click)="toggleFilter()"
        [class.active]="filterOpen()">
        <span class="filter-icon">üîç</span>
        Filter
        @if (filterFrom() || filterTo()) {
          <span class="filter-badge">‚óè</span>
        }
      </button>
      @if (filterOpen()) {
        <app-ride-history-filter-panel
          [initialFrom]="filterFrom()"
          [initialTo]="filterTo()"
          (filterApplied)="onFilterApply($event)"
          (resetClicked)="onFilterClear()"
        />
      }
    </div>
  </div>

  <!-- Current search info -->
  @if (currentEmail()) {
    <p class="search-info">Showing rides for: <strong>{{ currentEmail() }}</strong></p>
  }

  <!-- Error message -->
  @if (error()) {
    <div class="error-message">{{ error() }}</div>
  }

  <div class="history-page__container">
    @if (loading()) {
      <div class="loading-state">
        <span class="loading-spinner"></span>
        Loading rides...
      </div>
    } @else {
      <div class="table-wrapper">
        <table class="rides-table">
          <thead>
            <tr>
              <th (click)="onSort('ROUTE')" class="sortable" id="route-sorter">
                Route {{ getSortIndicator('ROUTE') }}
              </th>
              <th (click)="onSort('START_TIME')" class="sortable" id="start-time-sorter">
                Started {{ getSortIndicator('START_TIME') }}
              </th>
              <th (click)="onSort('END_TIME')" class="sortable" id="end-time-sorter">
                Ended {{ getSortIndicator('END_TIME') }}
              </th>
              <th (click)="onSort('CANCELLED_BY')" class="sortable" id="canceled-sorter">
                Canceled {{ getSortIndicator('CANCELLED_BY') }}
              </th>
              <th (click)="onSort('PRICE')" class="sortable" id="price-sorter">
                Price ($) {{ getSortIndicator('PRICE') }}
              </th>
              <th (click)="onSort('PANIC')" class="sortable" id="panic-sorter">
                Panic {{ getSortIndicator('PANIC') }}
              </th>
            </tr>
          </thead>
          <tbody>
            @if (rides().length === 0) {
              <tr class="empty-row">
                <td colspan="6" class="empty-cell">
                  @if (!searched()) {
                    Enter an email address to search for rides.
                  } @else {
                    No rides found for this user.
                  }
                </td>
              </tr>
            }
            @for (ride of rides(); track ride.rideId) {
              <tr class="ride-row" (click)="onRowClick(ride)">
                <td class="route-cell" id="route-cell">
                  {{ formatRoute(ride) }}
                </td>
                <td id="start-time-cell">{{ formatDateTime(ride.startTime) }}</td>
                <td id="end-time-cell">{{ formatDateTime(ride.endTime) }}</td>
                <td id="canceled-cell">{{ formatCanceled(ride) }}</td>
                <td class="price-cell" id="price-cell">{{ ride.price | number:'1.0-2' }}</td>
                <td [class.panic-indicator]="ride.panicTriggered" [class.panic-no]="!ride.panicTriggered" id="panic-cell">
                  {{ formatPanic(ride.panicTriggered) }}
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</div>

<!-- Details Modal -->
@if (detailsOpen()) {
  <app-admin-ride-details-modal
    [details]="selectedRideDetails()"
    [loading]="detailsLoading()"
    (close)="closeDetails()"
  />
}
